<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Travis CI Enterprise Operations Manual - Travis CI</title>
<link rel="stylesheet" href="/assets/stylesheets/main.css">
<link rel="alternate" type="application/rss+xml" title="Travis CI Build Environment Updates" href="http://docs.travis-ci.com/feed.build-env-updates.xml">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" defer></script>
<script src="/assets/javascripts/site.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/main.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/prism.js" type="text/javascript" charset="utf-8" defer></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24868285-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
  <a href="http://travis-ci.org/" title="Travis CI">Travis</a>
</h1>
    <nav>
      <ul id="navigation" class="navigation">
        <li><a href="http://blog.travis-ci.com">Blog</a></li>
        <li><a href="/">Docs</a></li>
        <li class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></li>
      </ul>
    </nav>
  </div>
</header>


      <div id="content" class="row">

        <div id="sidebar" class="sidebar">
  <div>
    <!-- <h2>Search</h2> -->
    <div class="searchbox">
      <form>
        <input type="text" id="st-search-input" class="searchbox-input" placeholder="Search the docs" />
      </form>
      <script type="text/javascript">
      var Swiftype = window.Swiftype || {};
        (function() {
          Swiftype.key = 'tXvDDzd4fNTBnLvxfEyx';

      Swiftype.searchSearchFields = {
            "page": ["title, body, tags"]
          };
          Swiftype.autocompleteSearchFields = {
            "page": ["title, body, tags"]
          };
          /** DO NOT EDIT BELOW THIS LINE **/
          var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
          script.src = "//swiftype.com/embed.js";
          var entry = document.getElementsByTagName('script')[0];
          document.getElementsByTagName('script')[0].parentNode.insertBefore(script, entry);
        }());
      </script>
    </div>
  </div>

  <section class="sidebar-navigation">
    <nav>
      <h3>Travis CI Enterprise</h3>
      <ul>
        <li><a href="/user/enterprise/">About Travis CI Enterprise</a></li>
        
          <li><a href="/user/enterprise/prerequisites/">System Prerequisites</a></li>
        
          <li><a href="/user/enterprise/installation/">Installation</a></li>
        
          <li><a href="/user/enterprise/upgrading/">Upgrading</a></li>
        
          <li><a href="/user/enterprise/build-images/">Customizing Build Images</a></li>
        
          <li><a href="/user/enterprise/custom-queues/">Custom Queues</a></li>
        
          <li><a href="/user/enterprise/worker-configuration/">Worker Configuration</a></li>
        
          <li><a href="/user/enterprise/worker-cli-commands/">Worker Start & Debug Containers</a></li>
        
          <li><a href="/user/enterprise/platform-tips/">Platform Administration Tips</a></li>
        
          <li><a href="/user/enterprise/trusty/">Trusty Build Environment</a></li>
        
          <li><a href="/user/enterprise/precise/">Precise (Legacy) Build Environment</a></li>
        
          <li><a href="/user/enterprise/operations-manual/">Operations Manual</a></li>
        
      </ul>
      <h3>Travis CI Docs</h3>
      <ul>
        <li><a href="/">Travis CI Docs</a></li>
      </ul>
    </nav>
  </section>

  <section class="sidebar-notice">
    <p>This documentation site is open source.
      The <a href="https://github.com/travis-ci/docs-travis-ci-com">README in our Git repository</a> explains how to contribute.</p>
  </section>

</div><!-- /#sidebar -->


        <main id="main" class="main" data-swiftype-index='true'>
          
            <aside class="improve-page"><a href="https://github.com/travis-ci/docs-travis-ci-com/edit/master/user/enterprise/operations-manual.md" target="_blank" title="Edit this page on GitHub" class="button-pen" data-proofer-ignore>Improve this page on GitHub</a></aside>
            <h1 class="title">Travis CI Enterprise Operations Manual</h1>
          
          <p>Welcome to the Travis CI Enterprise Operations Manual! This document provides guidelines and suggestions for troubleshooting your Travis CI Enterprise instance. If you have questions about a specific situation, please get in touch with us via <a href="mailto:enterprise@travis-ci.com">enterprise@travis-ci.com</a>.</p>

<p>This document provides guidelines and suggestions for troubleshooting your Travis CI Enterprise instance. Each topic contains a common problem, and a suggested solution. If the solution does not work, please <a href="#Contact-Enterprise-Support">contact support</a>.</p>

<p>Throughout this document we’ll be using the following terms to refer to the two components of your Travis CI Enterprise installation:</p>

<ul>
  <li><code class="highlighter-rouge">Platform machine</code>: The virtual machine that runs most of the Travis web components. This is the machine your domain is pointing to.</li>
  <li><code class="highlighter-rouge">Worker machine</code>: The worker machine(s) run your builds.</li>
</ul>

<blockquote>
  <p>Please note that this guide is geared towards non-High Availability (HA) setups right now.</p>
</blockquote>

<div id="toc"></div>

<h2 id="backups">Backups</h2>

<p>This section explains how you integrate Travis CI Enterprise in your backup strategy. Here, we’ll talk about two topics:</p>

<ul>
  <li>The encryption key</li>
  <li>The data directories</li>
</ul>

<h3 id="encryption-key">Encryption key</h3>

<p>Without the encryption key you cannot access the information in your production database. To make sure that you can always recover your database, make a backup of this key.</p>

<blockquote>
  <p>Without the encryption key the information in the database is not recoverable.</p>
</blockquote>

<p>To make a backup, please follow these steps:</p>

<ol>
  <li>open a ssh connection to the platform machine</li>
  <li>run <code class="highlighter-rouge">travis bash</code>. This will open a bash session with <code class="highlighter-rouge">root</code> privileges into the Travis container.</li>
  <li>Then run <code class="highlighter-rouge">grep -A1 encryption: /usr/local/travis/etc/travis/config/travis.yml</code>. Create a backup of the value returned by that command by either writing it down on a piece of paper or storing it on a different computer.</li>
</ol>

<h3 id="create-a-backup-of-the-data-directories">Create a backup of the data directories</h3>

<p>The data directories are located on the platform machine and get mounted into the Travis container. In these directories you’ll find files from RabbitMQ, Postgres, Slanger, Redis and also log files from the applications inside the container.</p>

<p>The files are located at <code class="highlighter-rouge">/var/travis</code> on the platform machine. Please run <code class="highlighter-rouge">sudo tar -czvf travis-enterprise-data-backup.tar.gz /var/travis</code> to create compressed archive from this folder. After this has finished, copy this file off the machine to a secure location.</p>

<h2 id="builds-are-not-starting">Builds are not starting</h2>

<h3 id="the-problem">The problem</h3>

<p>In the Travis CI Web UI you see none of the builds are starting. They’re either in no state or <code class="highlighter-rouge">queued</code>. Canceling and restarting them doesn’t make any difference.</p>

<h3 id="strategies">Strategies</h3>

<p>There are a few different potential approaches which may help get builds running again. Please try each one in order.</p>

<h4 id="connection-to-rabbitmq-got-lost">Connection to RabbitMQ got lost</h4>

<p>We’re using RabbitMQ to schedule builds for the worker machine(s). Sometimes the worker machine(s) lose the connection to RabbitMQ and therefore don’t run any new builds anymore. This is a known problem on our side and we’re working on resolving this. To get everything back to normal, restart the machines by connecting via <code class="highlighter-rouge">ssh</code> and running the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>shutdown <span class="nt">-r</span> 0
</code></pre></div></div>

<p>This will immediately restart the machine. <code class="highlighter-rouge">travis-worker</code>, the program which actually runs the builds, is configured to start automatically on system startup.</p>

<h4 id="configuration">Configuration</h4>

<p>Please check if the worker machine has all relevant configuration in order. To do so, please use ssh to login to the machine, then open <code class="highlighter-rouge">/etc/default/travis-enterprise</code>. This is the main configuration file <code class="highlighter-rouge">travis-worker</code> uses to connect to the platform machine. Below you find an example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Default ENV variables for Travis Enterprise
# Uncomment and set, then restart `travis-worker` for
# them to take effect.

export TRAVIS_ENTERPRISE_BUILD_ENDPOINT="__build__"
export TRAVIS_ENTERPRISE_HOST="travisci.example.com"
export TRAVIS_ENTERPRISE_SECURITY_TOKEN="abc12345"
# export TRAVIS_WORKER_DOCKER_PRIVILEGED="true"
</code></pre></div></div>

<p>Relevant are <code class="highlighter-rouge">TRAVIS_ENTERPRISE_HOST</code> and <code class="highlighter-rouge">TRAVIS_ENTERPRISE_SECURITY_TOKEN</code>. The former needs to contain your primary domain you use to access the Travis CI Enterprise Web UI. <code class="highlighter-rouge">travis-worker</code> uses this domain to reach the platform machine. The value of the latter needs to match the <code class="highlighter-rouge">RabbitMQ Password</code> on <code class="highlighter-rouge">https://yourdomain.com:8800/settings</code>. If you have made changes to this file, please run the following so they take effect:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>restart travis-worker
</code></pre></div></div>

<h4 id="ports-are-not-open-security-groups--firewall">Ports are not open Security groups / Firewall</h4>

<p>A source for the problem could be that the worker machine is not able to communicate with the platform machine.</p>

<p>Here we’re distinguishing between an AWS EC2 installation and an installation running on other hardware. For the former, security groups need to be configured per machine. To do so, please follow our installation instructions <a href="/user/enterprise/installation/#Create-a-Travis-CI-Platform-Security-Group">here</a>. If you’re not using AWS EC2, please make sure that the ports listed <a href="/user/enterprise/installation/#Create-a-Travis-CI-Platform-Security-Group">in the docs</a> are open in your firewall.</p>

<h4 id="docker-versions-mismatched">Docker Versions Mismatched</h4>

<p>This issue sometimes occurs after maintenance on workers installed before November 2017 or systems running a <code class="highlighter-rouge">docker version</code> before <code class="highlighter-rouge">17.06.2-ce</code>. When this happens, the <code class="highlighter-rouge">/var/log/upstart/travis-worker.log</code> file contains a line: <code class="highlighter-rouge">Error response from daemon:client and server don't have same version</code>. For this issue, we recommend <a href="/user/enterprise/installation/#Install-Travis-CI-Enterprise-Worker">re-installing worker from scratch</a> on a fresh instance. Please note: the default build environment images will be pulled and you may need to apply customizations again as well.</p>

<p>If none of the steps above lead to results for you, please follow the steps in the <a href="#Contact-Enterprise-Support">Contact Enterprise Support</a> section below to move forward.</p>

<h4 id="builds-are-not-starting-on-enterprise-installation-at-version-22">Builds are not Starting on Enterprise Installation at Version 2.2+</h4>

<p>If you are running version 2.2+ on your Platform, Travis CI will try to route builds to the <code class="highlighter-rouge">builds.trusty</code> queue by default. To address this, either:</p>

<ol>
  <li>Install a Trusty worker on a fresh vm instance: <a href="/user/enterprise/trusty/">Trusty installation guide</a></li>
  <li>Override the default queuing behavior: Go to Admin Dashboard at <code class="highlighter-rouge">https://your-domain.tld:8800/settings#override_default_dist_enable</code>, and toggle the the “Override Default Build Environment” button</li>
</ol>

<h2 id="enterprise-container-start-fails-with-ready-state-command-canceled-context-deadline-exceeded">Enterprise container start fails with <code class="highlighter-rouge">Ready state command canceled: context deadline exceeded</code></h2>

<p>After a fresh installation or configuration change the Travis CI Enterprise container doesn’t start and fails with the error <code class="highlighter-rouge">Ready state command canceled: context deadline exceeded</code> in the admin dashboard (<code class="highlighter-rouge">https://travis.example.com:8800/dashboard</code>).</p>

<h3 id="strategies-1">Strategies</h3>

<h4 id="github-oauth-app-configuration">GitHub OAuth app configuration</h4>

<p>The above mentioned error can be caused by a configuration mismatch in <a href="https://docs.travis-ci.com/user/enterprise/prerequisites/#OAuth-App">the GitHub OAuth Application</a>. Please check that <em>both</em> website and callback URL contain the Travis CI Enterprise’s hostname. If you have discovered a mismatch here, please restart the Travis container from within the admin dashboard.</p>

<h4 id="hostname-does-not-match-licenses-hostname">Hostname does not match license’s hostname</h4>

<p>Your Travis CI Enterprise license has a hostname field which contains the hostname of your installation. When the license’s hostname does not match the actual hostname, the container does not start. If this is the case or you suspect that this might be likely, please <a href="mailto:enterprise@travis-ci.com?subject=License%20Hostname%20Change">get in touch with us</a> and we’ll help you to get back on track.</p>

<h2 id="travis-worker-on-ubuntu-1604-does-not-start">travis-worker on Ubuntu 16.04 does not start</h2>

<p>travis-worker got installed on a fresh installation of Ubuntu 16.04 (Xenial). <code class="highlighter-rouge">sudo systemctl status travis-worker</code> shows that it is not running.</p>

<p>Either <code class="highlighter-rouge">sudo journalctl -u travis-worker</code> or <code class="highlighter-rouge">sudo systemctl status travis-worker</code> report <code class="highlighter-rouge">/usr/local/bin/travis-worker-wrapper: line 20: /var/tmp/travis-run.d/travis-worker: No such file or directory</code>.</p>

<h3 id="strategy">Strategy</h3>

<p>One possible reason that travis-worker is not running is that <code class="highlighter-rouge">systemctl</code> cannot create a temporary directory for environment files. To fix this, please create the directory <code class="highlighter-rouge">/var/tmp/travis-run.d/travis-worker</code> and assign write permissions via:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>mkdir <span class="nt">-p</span> /var/tmp/travis-run.d/
<span class="nv">$ </span>chown <span class="nt">-R</span> travis:travis /var/tmp/travis-run.d/
</code></pre></div></div>

<h2 id="contact-enterprise-support">Contact Enterprise Support</h2>

<p>To get in touch with us, please write a message to 
<a href="mailto:enterprise@travis-ci.com">enterprise@travis-ci.com</a>. If possible, 
please include as much of the following as you can:</p>

<ul>
  <li>Description of the problem - what are you observing?</li>
  <li>Which steps did you try already?</li>
  <li>A support bundle (You can get it from <code class="highlighter-rouge">https://yourdomain:8800/support</code>)</li>
  <li>Log files from all workers (They can be found at <code class="highlighter-rouge">/var/log/upstart/travis-worker.log</code> - please include as many as you can retrieve).</li>
  <li>If a build failed or errored, a text file of the build log</li>
</ul>

<p>Have you made any customizations to your setup? While we may be able to see some 
information (such as hostname, IaaS provider, and license expiration), there 
are many other things we can’t see which could lead to something not working. 
Therefore , we’d like to ask you to also answer the questions below in your 
support request (if applicable):</p>

<ul>
  <li>How many machines are you using?</li>
  <li>Do you use configuration management tools (Chef, Puppet)?</li>
  <li>Which other services do interface with Travis CI Enterprise?</li>
  <li>Do you use Travis CI Enterprise together with github.com or GitHub Enterprise?</li>
  <li>If you’re using GitHub Enterprise, which version of it?</li>
</ul>

<p>We’re looking forward to helping!</p>


        </main>
      </div><!-- /#content -->

      <footer class="footer">
  <div class="inner row">
    <div class="footer-elem">
      <div class="travis-footer">
        <img alt="The Travis CI logo" src="/images/ui/footer-logo.svg"></div>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">&copy;Travis CI, GmbH</h3>
      <address>Rigaer Straße 8<br>10247 Berlin, Germany</address>
      <ul>
        <li><a href="https://docs.travis-ci.com/imprint.html" title="Imprint">Imprint</a></li>
        <li><a href="https://travisci.workable.com/" title="Jobs at Travis CI">Jobs</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Help</h3>
      <ul>
        <li><a href="https://docs.travis-ci.com" title="Travis CI Docs">Documentation</a></li>
        <li><a href="https://blog.travis-ci.com/" title="Travis CI Blog">Blog</a></li>
        <li><a href="mailto:support@travis-ci.com" title="Email Travis CI support">Email</a></li>
        <li><a href="https://twitter.com/travisci" title="Travis CI on Twitter">Twitter</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Travis CI Status</h3>
      <ul>
        <li><div class="status-circle status">Status:</div>
          <a href="http://www.traviscistatus.com/">Travis CI Status</a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    </div><!-- /.wrapper -->
  </body>
</html>
