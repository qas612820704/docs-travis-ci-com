<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Upgrading Travis CI Enterprise - Travis CI</title>
<link rel="stylesheet" href="/assets/stylesheets/main.css">
<link rel="alternate" type="application/rss+xml" title="Travis CI Build Environment Updates" href="http://docs.travis-ci.com/feed.build-env-updates.xml">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" defer></script>
<script src="/assets/javascripts/site.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/main.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/prism.js" type="text/javascript" charset="utf-8" defer></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24868285-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
  <a href="http://travis-ci.org/" title="Travis CI">Travis</a>
</h1>
    <nav>
      <ul id="navigation" class="navigation">
        <li><a href="http://blog.travis-ci.com">Blog</a></li>
        <li><a href="/">Docs</a></li>
        <li class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></li>
      </ul>
    </nav>
  </div>
</header>


      <div id="content" class="row">

        <div id="sidebar" class="sidebar">
  <div>
    <!-- <h2>Search</h2> -->
    <div class="searchbox">
      <form>
        <input type="text" id="st-search-input" class="searchbox-input" placeholder="Search the docs" />
      </form>
      <script type="text/javascript">
      var Swiftype = window.Swiftype || {};
        (function() {
          Swiftype.key = 'tXvDDzd4fNTBnLvxfEyx';

      Swiftype.searchSearchFields = {
            "page": ["title, body, tags"]
          };
          Swiftype.autocompleteSearchFields = {
            "page": ["title, body, tags"]
          };
          /** DO NOT EDIT BELOW THIS LINE **/
          var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
          script.src = "//swiftype.com/embed.js";
          var entry = document.getElementsByTagName('script')[0];
          document.getElementsByTagName('script')[0].parentNode.insertBefore(script, entry);
        }());
      </script>
    </div>
  </div>

  <section class="sidebar-navigation">
    <nav>
      <h3>Travis CI Enterprise</h3>
      <ul>
        <li><a href="/user/enterprise/">About Travis CI Enterprise</a></li>
        
          <li><a href="/user/enterprise/prerequisites/">System Prerequisites</a></li>
        
          <li><a href="/user/enterprise/installation/">Installation</a></li>
        
          <li><a href="/user/enterprise/upgrading/">Upgrading</a></li>
        
          <li><a href="/user/enterprise/build-images/">Customizing Build Images</a></li>
        
          <li><a href="/user/enterprise/custom-queues/">Custom Queues</a></li>
        
          <li><a href="/user/enterprise/worker-configuration/">Worker Configuration</a></li>
        
          <li><a href="/user/enterprise/worker-cli-commands/">Worker Start & Debug Containers</a></li>
        
          <li><a href="/user/enterprise/platform-tips/">Platform Administration Tips</a></li>
        
          <li><a href="/user/enterprise/trusty/">Trusty Build Environment</a></li>
        
          <li><a href="/user/enterprise/precise/">Precise (Legacy) Build Environment</a></li>
        
          <li><a href="/user/enterprise/operations-manual/">Operations Manual</a></li>
        
      </ul>
      <h3>Travis CI Docs</h3>
      <ul>
        <li><a href="/">Travis CI Docs</a></li>
      </ul>
    </nav>
  </section>

  <section class="sidebar-notice">
    <p>This documentation site is open source.
      The <a href="https://github.com/travis-ci/docs-travis-ci-com">README in our Git repository</a> explains how to contribute.</p>
  </section>

</div><!-- /#sidebar -->


        <main id="main" class="main" data-swiftype-index='true'>
          
            <aside class="improve-page"><a href="https://github.com/travis-ci/docs-travis-ci-com/edit/master/user/enterprise/upgrading.md" target="_blank" title="Edit this page on GitHub" class="button-pen" data-proofer-ignore>Improve this page on GitHub</a></aside>
            <h1 class="title">Upgrading Travis CI Enterprise</h1>
          
          <div id="toc"></div>

<h2 id="backups">Backups</h2>

<p>Before upgrading, we <strong>strongly recommend</strong> taking a snapshot of <code class="highlighter-rouge">/etc/travis</code>
and <code class="highlighter-rouge">/var/travis</code>.</p>

<p>One good way to do this is to run</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo tar -cvzf travis-backup-$(date +%s).tar.gz /var/travis /etc/travis/
</code></pre></div></div>

<h2 id="updating-your-travis-ci-enterprise-platform">Updating your Travis CI Enterprise Platform</h2>

<p>You can check for new releases by going to the management interface
dashboard <code class="highlighter-rouge">https://:8800</code> and clicking on the ‘Check Now’ button. If an
update is available you will be able to read the release notes and
install the update.</p>

<p><strong>Please note that this will cause downtime for the platform, because
Replicated services get restarted during the update.</strong></p>

<h2 id="updating-replicated-on-the-platform">Updating Replicated on the Platform</h2>

<p>To update Replicated on the Platform installation you’ll want to run
the install script which will download the latest version. Depending on
whether you are behind a web proxy you’ll want to run one of these:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl -sSL -o /tmp/installer.sh https://enterprise.travis-ci.com/install
  sudo bash /tmp/installer.sh
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl -sSL -x http://: -o /tmp/installer.sh https://enterprise.travis-ci.com/install
  sudo bash /tmp/installer.sh http-proxy=http://:
</code></pre></div></div>

<h2 id="updating-your-travis-ci-enterprise-worker">Updating your Travis CI Enterprise Worker</h2>

<p>In order to update the Worker, you can run the following on each worker
host:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo apt-get update
  sudo apt-get install travis-worker
</code></pre></div></div>

<h2 id="upgrading-from-1x-to-2x">Upgrading from 1.x to 2.x</h2>

<h3 id="step-1-let-the-travis-team-know-youre-ready-to-upgrade-to-20">Step 1: Let the Travis team know you’re ready to upgrade to 2.0</h3>

<p>Let us know you want to upgrade to Travis CI Enterprise 2.0 by emailing <a href="mailto:enterprise@travis-ci.com">enterprise@travis-ci.com</a>. This will let us put your license in “Migration Mode” and change your release channel to “2.0” so you can see the newest Travis CI. Additionally we’ll provide you with a backup of your license in case you need to restore from back ups or do a fresh install.</p>

<h3 id="step-2-back-up-the-travis-encryption-key-and-rabbitmq-password">Step 2: Back up the Travis Encryption Key and RabbitMQ password</h3>

<p>Once your License is in “Migration Mode” you’ll see a new field at the bottom of the Admin Settings page (<code class="highlighter-rouge">https://[your travis URL]:8800/settings</code>) called “Travis Encryption Key”. It’s in the “Advanced Settings” section. <strong>Copy down your Travis Encryption Key and store it in a safe place, without this you won’t be able to read your database in the event you need to restore from a backup.</strong></p>

<p>Additionally, towards the top of the same settings page, there’s a field named “RabbitMQ Password”, this is the password that all of your workers use to connect to the platform server. <strong>Copy down your RabbitMQ Password as well.</strong></p>

<h3 id="step-3-back-up-the-databases-and-configuarion">Step 3: Back up the databases and configuarion</h3>

<p>SSH into the Platform machine and <strong>back up <code class="highlighter-rouge">/var/travis</code> and <code class="highlighter-rouge">/etc/travis</code></strong>. One good way to do this is to run</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  sudo tar -cvzf travis-backup-$(date +%s).tar.gz /var/travis /etc/travis/
</code></pre></div></div>

<p>This will create a timestamped back up of these directories.</p>

<h3 id="step-4-confirm-you-have-enough-diskspace-free-for-an-upgrade">Step 4: Confirm you have enough diskspace free for an upgrade</h3>

<p>While SSH’d into the Platform machine, make sure you have sufficient disk space free to finish the migration by running <code class="highlighter-rouge">df -h</code>. Five gigs should be plenty.</p>

<h3 id="step-5-upgrade-to-the-latest-version-of-replicated">Step 5: Upgrade to the latest version of Replicated</h3>

<p>Check to see if replicated needs to be upgraded to the latest version by running <code class="highlighter-rouge">replicated --version</code>. Also, check the version of Docker that you have installed by running <code class="highlighter-rouge">docker --version</code>. If your Docker version is less than 1.9.x you’ll want to upgrade to the latest version by following the directions here before upgrading your version of Replicated. If Replicated is 2.0 or higher and Docker is 1.9 or higher, run:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl -sSL -o /tmp/installer.sh https://enterprise.travis-ci.com/install
  sudo bash /tmp/installer.sh
</code></pre></div></div>

<p>If it’s less than 2.0, you’ll need to migrate to the 2.X version of Replicated. You can do this by running:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl -sSL -o /tmp/migrate-v2.sh https://get.replicated.com/migrate-v2
  sudo bash /tmp/migrate-v2.sh
</code></pre></div></div>

<p>These steps will stop Travis CI Enterprise while they run. So it’s important to plan for downtime when you run them. The Replicated migration/upgrade tends to take less than 5-10 minutes but can depend on your network connection and size of database.</p>

<h3 id="step-6-check-for-the-newest-travis-ci-enterprise-release">Step 6: Check for the newest Travis CI Enterprise Release</h3>

<p>Once the new version of Replicated is running, go to <code class="highlighter-rouge">http(s)://[your hostname]:8080/releases</code> and press the “Check Now” button. This will check for new versions of Travis Enterprise CI, wait until it has finished loading all of the releases before clicking install.</p>

<h3 id="step-7-install-travis-ci-enterprise">Step 7: Install Travis CI Enterprise</h3>

<p>Click “Install”. Once this finishes, your Travis CI Enterprise container will restart to bring up the new one you just downloaded. This can introduce a small amount of downtime while it restarts. But once done you’ll be on the latest version of Travis CI Enterprise!</p>

<h3 id="restoring-from-backups">Restoring from backups</h3>

<p>In the rare event of something going wrong during the upgrade you may need to restore from backup. To do that, follow these steps:</p>

<ol>
  <li>Boot up a replacement machine with a fresh install of Ubuntu 14.04.</li>
  <li>Follow the directions at https://docs.travis-ci.com/user/enterprise/installation/ and use the license we supplied you with in Step 1 in the migration steps. If you cannot find this, contact us at enterprise@travis-ci.com</li>
  <li>Setup your Travis CI instance filling out the settings as needed. Fill in the RabbitMQ password and Travis Encryption Key that you saved. Save the settings and start up the Travis container.</li>
  <li>Stop the Travis CI container in the Replicated dashboard.</li>
  <li>As a superuser (to preserve user permissions), unzip the Travis backup you made and copy the directories to the appropriate places (/var/travis and /etc/travis).</li>
  <li>Start Travis CI via the Replicated dashboard</li>
</ol>

<p>Note, that this does still put you on the latest version of Travis CI Enterprise. Rolling back strategies will need to be coordinated with the Travis CI team as it requires changing licenses back to the legacy release channel.</p>

<h2 id="contact-enterprise-support">Contact Enterprise Support</h2>

<p>To get in touch with us, please write a message to 
<a href="mailto:enterprise@travis-ci.com">enterprise@travis-ci.com</a>. If possible, 
please include as much of the following as you can:</p>

<ul>
  <li>Description of the problem - what are you observing?</li>
  <li>Which steps did you try already?</li>
  <li>A support bundle (You can get it from <code class="highlighter-rouge">https://yourdomain:8800/support</code>)</li>
  <li>Log files from all workers (They can be found at <code class="highlighter-rouge">/var/log/upstart/travis-worker.log</code> - please include as many as you can retrieve).</li>
  <li>If a build failed or errored, a text file of the build log</li>
</ul>

<p>Have you made any customizations to your setup? While we may be able to see some 
information (such as hostname, IaaS provider, and license expiration), there 
are many other things we can’t see which could lead to something not working. 
Therefore , we’d like to ask you to also answer the questions below in your 
support request (if applicable):</p>

<ul>
  <li>How many machines are you using?</li>
  <li>Do you use configuration management tools (Chef, Puppet)?</li>
  <li>Which other services do interface with Travis CI Enterprise?</li>
  <li>Do you use Travis CI Enterprise together with github.com or GitHub Enterprise?</li>
  <li>If you’re using GitHub Enterprise, which version of it?</li>
</ul>

<p>We’re looking forward to helping!</p>

        </main>
      </div><!-- /#content -->

      <footer class="footer">
  <div class="inner row">
    <div class="footer-elem">
      <div class="travis-footer">
        <img alt="The Travis CI logo" src="/images/ui/footer-logo.svg"></div>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">&copy;Travis CI, GmbH</h3>
      <address>Rigaer Straße 8<br>10247 Berlin, Germany</address>
      <ul>
        <li><a href="https://docs.travis-ci.com/imprint.html" title="Imprint">Imprint</a></li>
        <li><a href="https://travisci.workable.com/" title="Jobs at Travis CI">Jobs</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Help</h3>
      <ul>
        <li><a href="https://docs.travis-ci.com" title="Travis CI Docs">Documentation</a></li>
        <li><a href="https://blog.travis-ci.com/" title="Travis CI Blog">Blog</a></li>
        <li><a href="mailto:support@travis-ci.com" title="Email Travis CI support">Email</a></li>
        <li><a href="https://twitter.com/travisci" title="Travis CI on Twitter">Twitter</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Travis CI Status</h3>
      <ul>
        <li><div class="status-circle status">Status:</div>
          <a href="http://www.traviscistatus.com/">Travis CI Status</a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    </div><!-- /.wrapper -->
  </body>
</html>
