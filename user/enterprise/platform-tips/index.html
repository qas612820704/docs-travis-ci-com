<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Enterprise Platform Administration Tips - Travis CI</title>
<link rel="stylesheet" href="/assets/stylesheets/main.css">
<link rel="alternate" type="application/rss+xml" title="Travis CI Build Environment Updates" href="http://docs.travis-ci.com/feed.build-env-updates.xml">
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js" defer></script>
<script src="/assets/javascripts/site.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/main.js" type="text/javascript" charset="utf-8" defer></script>
<script src="/assets/javascripts/prism.js" type="text/javascript" charset="utf-8" defer></script>



<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-24868285-6']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </head>
  <body>
    <div class="wrapper">

      <header class="top">
  <div class="row topbar">
    <h1 id="logo" class="logo">
  <a href="http://travis-ci.org/" title="Travis CI">Travis</a>
</h1>
    <nav>
      <ul id="navigation" class="navigation">
        <li><a href="http://blog.travis-ci.com">Blog</a></li>
        <li><a href="/">Docs</a></li>
        <li class="toggle"><button type="button" id="toggle-menu" class="button--teal">Menu</button></li>
      </ul>
    </nav>
  </div>
</header>


      <div id="content" class="row">

        <div id="sidebar" class="sidebar">
  <div>
    <!-- <h2>Search</h2> -->
    <div class="searchbox">
      <form>
        <input type="text" id="st-search-input" class="searchbox-input" placeholder="Search the docs" />
      </form>
      <script type="text/javascript">
      var Swiftype = window.Swiftype || {};
        (function() {
          Swiftype.key = 'tXvDDzd4fNTBnLvxfEyx';

      Swiftype.searchSearchFields = {
            "page": ["title, body, tags"]
          };
          Swiftype.autocompleteSearchFields = {
            "page": ["title, body, tags"]
          };
          /** DO NOT EDIT BELOW THIS LINE **/
          var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
          script.src = "//swiftype.com/embed.js";
          var entry = document.getElementsByTagName('script')[0];
          document.getElementsByTagName('script')[0].parentNode.insertBefore(script, entry);
        }());
      </script>
    </div>
  </div>

  <section class="sidebar-navigation">
    <nav>
      <h3>Travis CI Enterprise</h3>
      <ul>
        <li><a href="/user/enterprise/">About Travis CI Enterprise</a></li>
        
          <li><a href="/user/enterprise/prerequisites/">System Prerequisites</a></li>
        
          <li><a href="/user/enterprise/installation/">Installation</a></li>
        
          <li><a href="/user/enterprise/upgrading/">Upgrading</a></li>
        
          <li><a href="/user/enterprise/build-images/">Customizing Build Images</a></li>
        
          <li><a href="/user/enterprise/custom-queues/">Custom Queues</a></li>
        
          <li><a href="/user/enterprise/worker-configuration/">Worker Configuration</a></li>
        
          <li><a href="/user/enterprise/worker-cli-commands/">Worker Start & Debug Containers</a></li>
        
          <li><a href="/user/enterprise/platform-tips/">Platform Administration Tips</a></li>
        
          <li><a href="/user/enterprise/trusty/">Trusty Build Environment</a></li>
        
          <li><a href="/user/enterprise/precise/">Precise (Legacy) Build Environment</a></li>
        
          <li><a href="/user/enterprise/operations-manual/">Operations Manual</a></li>
        
      </ul>
      <h3>Travis CI Docs</h3>
      <ul>
        <li><a href="/">Travis CI Docs</a></li>
      </ul>
    </nav>
  </section>

  <section class="sidebar-notice">
    <p>This documentation site is open source.
      The <a href="https://github.com/travis-ci/docs-travis-ci-com">README in our Git repository</a> explains how to contribute.</p>
  </section>

</div><!-- /#sidebar -->


        <main id="main" class="main" data-swiftype-index='true'>
          
            <aside class="improve-page"><a href="https://github.com/travis-ci/docs-travis-ci-com/edit/master/user/enterprise/platform-tips.md" target="_blank" title="Edit this page on GitHub" class="button-pen" data-proofer-ignore>Improve this page on GitHub</a></aside>
            <h1 class="title">Enterprise Platform Administration Tips</h1>
          
          <p>This page collects FAQs and day-to-day Enterprise Platform maintenance scripts
and tools. Please connect to your Platform machine via SSH before getting
started.</p>

<div id="toc"></div>

<h2 id="inspecting-logs-and-running-services">Inspecting logs and running services</h2>

<p>On the Platform you can find the main log file at
<code class="highlighter-rouge">/var/travis/log/travis.log</code>. They are also symlinked to
<code class="highlighter-rouge">/var/log/travis.log</code> for convenience.</p>

<p>On the Worker you can find the main log file at
<code class="highlighter-rouge">/var/log/upstart/travis-worker.log</code></p>

<h2 id="accessing-travis-container-and-console-on-the-platform">Accessing Travis Container and Console on the Platform</h2>

<p><code class="highlighter-rouge">travis bash</code>: This will get you into the running container on the
Platform.</p>

<p><code class="highlighter-rouge">travis console</code>: This will get you into a Ruby IRB session on the
Platform.</p>

<h2 id="cancel-or-reset-stuck-jobs">Cancel or Reset Stuck Jobs</h2>

<p>Occasionally, jobs can get stuck in a <code class="highlighter-rouge">queued</code> state on the worker. To cancel or
reset a large number of jobs, please execute the following steps:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ travis console
&gt;&gt; stuck_jobs = Job.where(queue: 'builds.linux', state: 'queued').where('queued_at &lt; NOW() - interval \'60 minutes\'').all
&gt;&gt; # Cancels all stuck jobs
&gt;&gt; stuck_jobs.each(&amp;:cancel!)
&gt;&gt; # Or reset them
&gt;&gt; stuck_jobs.each(&amp;:reset!)
</code></pre></div></div>

<h2 id="clear-redis-archive-queue-for-releases--217">Clear Redis Archive Queue (for releases &lt; 2.1.7)</h2>

<p>In releases of Enterprise before 2.1.7 jobs where enqueued in the archive queue
for log aggregation. This feature however is only available for the hosted
versions of Travis CI so far.</p>

<p>This results in the queue growing bigger and bigger, but not getting working
off. Because of that, Redis’ memory consumption increases over the time and can
lead to decreased performance of the whole platform. The solution to this is
rather simple, the <code class="highlighter-rouge">archive</code> queue has to be cleared to free system resources.
To clear it, please execute the following commands:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ travis console
&gt;&gt; require 'sidekiq/api'
&gt;&gt; Sidekiq::Queue.new('archive').clear
</code></pre></div></div>

<h2 id="reset-the-rabbitmq-certificate">Reset the RabbitMQ certificate</h2>

<p>After an upgrade of Replicated 2.8.0 to a newer version occasionally the service
restarts with the following error:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker inspect --format '{{.State.Error}}' focused_yalow
oci runtime error: container_linux.go:247: starting container process
caused "process_linux.go:359: container init caused
\"rootfs_linux.go:54: mounting
\\\"/var/lib/replicated-operator/44c648980d1e4b1c5a97167046f32f11/etc/travis/ssl/rabbitmq.cert\\\"
to rootfs
\\\"/var/lib/docker/aufs/mnt/a00833d25e72b761e2a0e72b1015dd2b2f3a32cafd2851ba408b298f73b37d37\\\"
at
\\\"/var/lib/docker/aufs/mnt/a00833d25e72b761e2a0e72b1015dd2b2f3a32cafd2851ba408b298f73b37d37/etc/travis/ssl/rabbitmq.cert\\\"
caused \\\"not a directory\\\"\""
: Are you trying to mount a directory onto a file (or vice-versa)? Check
if the specified host path exists and is the expected type
</code></pre></div></div>

<p>To address this, remove the RabbitMQ cert from <code class="highlighter-rouge">/etc/travis/ssl/</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo rm -r /etc/travis/ssl/rabbitmq.cert
</code></pre></div></div>
<p>After this, do a full reboot of the system and everything should start again properly.</p>

<h2 id="view-sidekiq-queue-statistics">View Sidekiq queue statistics</h2>

<p>In the past there have been reported cases where the system became unresponsive,
it took long until jobs where worked off or weren’t picked up at all. We found
out that oftentimes full Sidekiq queues played a part in this. To get some
insight about it helps to get some basics statistics in the Ruby console:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  $ travis console
  &gt;&gt; require 'sidekiq/api'
  =&gt; true
  &gt;&gt; stats = Sidekiq::Stats.new
  &gt;&gt; stats.queues
  =&gt; {"sync.low"=&gt;315316,
      "archive"=&gt;7900,
      "repo_sync"=&gt;193,
      "webhook"=&gt;0,
      "keen_events"=&gt;0,
      "scheduler"=&gt;0,
      "github_status"=&gt;0,
      "build_requests"=&gt;0,
      "build_restarts"=&gt;0,
      "hub"=&gt;0,
      "slack"=&gt;0,
      "pusher"=&gt;0,
      "pusher-live"=&gt;0,
      "build_cancellations"=&gt;0,
      "sync"=&gt;0,
      "user_sync"=&gt;0}
</code></pre></div></div>

<h2 id="use-a-lets-encrypt-ssl-certificate">Use a Let’s Encrypt SSL Certificate</h2>

<p>Travis CI Enterprise works well together with a Let’s Encrypt SSL Certificate. To obtain one for your domain, please follow the steps below.</p>

<p>What you need:</p>

<ol>
  <li>An email address Let’s Encrypt can send emails to. This will be used to notify about urgent renewal and security notices.</li>
  <li>A domain name under which your installation is available (we’re using <code class="highlighter-rouge">travis.example.com</code> in this guide).</li>
</ol>

<p><strong>Please note: This change will cause downtime for your system,for this reason, we recommend to perform this process in a maintenance window.</strong></p>

<p>To obtain an SSL certificate we’ll be using <a href="https://certbot.eff.org/#ubuntutrusty-other">certbot</a>. Certbot is available as an Ubuntu package.</p>

<p>Please login to your platform machine via SSH and run the following steps to install certbot:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get update
$ sudo apt-get install software-properties-common
$ sudo add-apt-repository ppa:certbot/certbot
$ sudo apt-get update
$ sudo apt-get install certbot
</code></pre></div></div>

<p><code class="highlighter-rouge">certbot</code> offers multiple ways to obtain a certificate. We’ll pick the <code class="highlighter-rouge">temporary webserver</code> option since it doesn’t require any additional configuration. The only prerequisite though is that the Travis CI Enterprise container has to be stopped so that webserver can bind to port 443 properly.</p>

<p><strong><em>To start</em></strong>, please stop Travis CI Enterprise:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ replicatedctl app stop
</code></pre></div></div>

<p><strong><em>Now</em></strong>, run the following to start the interactive process to obtain the SSL certificate:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo certbot certonly
</code></pre></div></div>

<p>It’ll first ask you <strong><em>to pick the authentication method:</em></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>How would you like to authenticate with the ACME CA?
-------------------------------------------------------------------------------
1: Spin up a temporary webserver (standalone)
2: Place files in webroot directory (webroot)
-------------------------------------------------------------------------------
Select the appropriate number [1-2] then [enter] (press 'c' to cancel): 1
</code></pre></div></div>

<p>Here, <strong><em>pick <code class="highlighter-rouge">1</code> and press return.</em></strong></p>

<p>Then, <strong><em>fill in the aforementioned email address:</em></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Enter email address (used for urgent renewal and security notices) (Enter 'c' to
cancel): ops@example.com
</code></pre></div></div>

<p>Then, <strong><em>accept the Terms of Services</em></strong> and decide if you’d like to share your email address with the EFF:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-------------------------------------------------------------------------------
Please read the Terms of Service at
https://letsencrypt.org/documents/LE-SA-v1.1.1-August-1-2016.pdf. You must agree
in order to register with the ACME server at
https://acme-v01.api.letsencrypt.org/directory
-------------------------------------------------------------------------------
(A)gree/(C)ancel: A

-------------------------------------------------------------------------------
Would you be willing to share your email address with the Electronic Frontier
Foundation, a founding partner of the Let's Encrypt project and the non-profit
organization that develops Certbot? We'd like to send you email about EFF and
our work to encrypt the web, protect its users and defend digital rights.
-------------------------------------------------------------------------------
(Y)es/(N)o: N
</code></pre></div></div>

<p>In the last step you’re <strong><em>providing your domain name:</em></strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Please enter in your domain name(s) (comma and/or space separated)  (Enter 'c'
to cancel): travis.example.com
</code></pre></div></div>

<p>After that <strong><em>finished successfully,</em></strong> you’ll see a message similar to the one below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>IMPORTANT NOTES:
 - Congratulations! Your certificate and chain have been saved at:
   /etc/letsencrypt/live/travis.example.com/fullchain.pem
   Your key file has been saved at:
   /etc/letsencrypt/live/travis.example.com/privkey.pem
   Your cert will expire on 2018-02-07. To obtain a new or tweaked
   version of this certificate in the future, simply run certbot
   again. To non-interactively renew *all* of your certificates, run
   "certbot renew"
</code></pre></div></div>

<p>Your certificate has been generated and is now saved on the machine. Please head over to <code class="highlighter-rouge">https://travis.example.com:8800/console/settings</code>.</p>

<p>There, in the <strong><em>TLS Key &amp; Cert</em></strong> section, select <strong><em>Server path</em></strong> and fill in the following:</p>

<ul>
  <li>SSL Private Key Filename: <code class="highlighter-rouge">/etc/letsencrypt/live/travis.example.com/privkey.pem</code></li>
  <li>SSL Certificate Filename: <code class="highlighter-rouge">/etc/letsencrypt/live/travis.example.com/fullchain.pem</code></li>
</ul>

<p>After that, <strong>scroll down and click “Save”</strong>. After your changes have been saved, you can restart Travis CI Enterprise via:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ replicatedctl app start
</code></pre></div></div>

<p>Let’s Encrypt certificates are short-lived, this means <strong><em>they expire after 90 days.</em></strong> This means that you’ll have to renew them on a regular basis. Thankfully this can be done with <code class="highlighter-rouge">certbot</code> as well. Run the following commands in order to renew your certificate.</p>

<p><strong>Note: Be aware that this process will also introduce downtime.</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ replicatedctl app stop
$ sudo certbot renew
$ replicatedctl app start
</code></pre></div></div>

<p>In general: These certificate renewals should be automated with a cron job.</p>

<h2 id="uninstall-travis-ci-enterprise">Uninstall Travis CI Enterprise</h2>

<p>If you wish to uninstall Travis CI Enterprise from your platform and worker
machines, please follow the instructions below. On the platform machine, you
need to run the following commands in order. <small>(Instructions copied over
from <a href="https://www.replicated.com/docs/distributing-an-application/installing-via-script/#removing-replicated">Replicated</a>)</small></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>service replicated stop
service replicated-ui stop
service replicated-operator stop
docker stop replicated-premkit
docker stop replicated-statsd
docker rm -f replicated replicated-ui replicated-operator replicated-premkit replicated-statsd
docker images | grep "quay\.io/replicated" | awk '{print $3}' | xargs sudo docker rmi -f
apt-get remove -y replicated replicated-ui replicated-operator
apt-get purge -y replicated replicated-ui replicated-operator
rm -rf /var/lib/replicated* /etc/replicated* /etc/init/replicated* /etc/init.d/replicated* /etc/default/replicated* /var/log/upstart/replicated* /etc/systemd/system/replicated*
</code></pre></div></div>

<p>On the worker machine, you need to run this command:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ sudo apt-get autoremove travis-worker
</code></pre></div></div>

<h2 id="contact-enterprise-support">Contact Enterprise Support</h2>

<p>To get in touch with us, please write a message to 
<a href="mailto:enterprise@travis-ci.com">enterprise@travis-ci.com</a>. If possible, 
please include as much of the following as you can:</p>

<ul>
  <li>Description of the problem - what are you observing?</li>
  <li>Which steps did you try already?</li>
  <li>A support bundle (You can get it from <code class="highlighter-rouge">https://yourdomain:8800/support</code>)</li>
  <li>Log files from all workers (They can be found at <code class="highlighter-rouge">/var/log/upstart/travis-worker.log</code> - please include as many as you can retrieve).</li>
  <li>If a build failed or errored, a text file of the build log</li>
</ul>

<p>Have you made any customizations to your setup? While we may be able to see some 
information (such as hostname, IaaS provider, and license expiration), there 
are many other things we can’t see which could lead to something not working. 
Therefore , we’d like to ask you to also answer the questions below in your 
support request (if applicable):</p>

<ul>
  <li>How many machines are you using?</li>
  <li>Do you use configuration management tools (Chef, Puppet)?</li>
  <li>Which other services do interface with Travis CI Enterprise?</li>
  <li>Do you use Travis CI Enterprise together with github.com or GitHub Enterprise?</li>
  <li>If you’re using GitHub Enterprise, which version of it?</li>
</ul>

<p>We’re looking forward to helping!</p>


        </main>
      </div><!-- /#content -->

      <footer class="footer">
  <div class="inner row">
    <div class="footer-elem">
      <div class="travis-footer">
        <img alt="The Travis CI logo" src="/images/ui/footer-logo.svg"></div>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">&copy;Travis CI, GmbH</h3>
      <address>Rigaer Straße 8<br>10247 Berlin, Germany</address>
      <ul>
        <li><a href="https://docs.travis-ci.com/imprint.html" title="Imprint">Imprint</a></li>
        <li><a href="https://travisci.workable.com/" title="Jobs at Travis CI">Jobs</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Help</h3>
      <ul>
        <li><a href="https://docs.travis-ci.com" title="Travis CI Docs">Documentation</a></li>
        <li><a href="https://blog.travis-ci.com/" title="Travis CI Blog">Blog</a></li>
        <li><a href="mailto:support@travis-ci.com" title="Email Travis CI support">Email</a></li>
        <li><a href="https://twitter.com/travisci" title="Travis CI on Twitter">Twitter</a></li>
      </ul>
    </div>

    <div class="footer-elem">
      <h3 class="footer-title">Travis CI Status</h3>
      <ul>
        <li><div class="status-circle status">Status:</div>
          <a href="http://www.traviscistatus.com/">Travis CI Status</a>
        </li>
      </ul>
    </div>
  </div>
</footer>

    </div><!-- /.wrapper -->
  </body>
</html>
